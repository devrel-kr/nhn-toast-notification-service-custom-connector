name: Release to GitHub

on:
  push:
    tags:
    - 'v*'

jobs:
  make_fncapp_json:
    uses: ./.github/workflows/make-function-apps-json.yaml
    with: 
      AZ_APP_SUFFIXES: ${{ secrets.AZURE_APP_SUFFIXES }}  

  call_CI_part:
    uses: ./.github/workflows/build-test-upload.yaml
    needs: 
    - make_fncapp_json
    with:
      matrix_json: ${{ needs.make_fncapp_json.outputs.matrix_json }}
    secrets: 
      AZ_RESOURCE_NAME: ${{ secrets.AZURE_RESOURCE_NAME }}

  call_CD_github:
    uses: ./.github/workflows/deployment-github.yaml
    needs: 
    - make_fncapp_json
    - call_CI_part
    with:
      tag: ${{ github.ref }}
      matrix_json: ${{ needs.make_fncapp_json.outputs.matrix_json }}
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}  
      