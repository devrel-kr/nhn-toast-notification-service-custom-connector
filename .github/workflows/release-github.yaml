name: Release to GitHub

on:
  push:
    tags:
    - 'v*'

jobs:
  make_fncapp_json:
    runs-on: ubuntu-latest

    outputs:
      matrix_json: ${{ steps.make_json.outputs.fncapp_json }}

    steps:
    - name: Make function-apps JSON string array
      id: make_json
      shell: bash
      run: |
        # list of function-app names
        array_app_name=("sms" "sms-verify")

        #'["sms","sms-verify"]'
        JSON="["

        for i in ${!array_app_name[@]}; do

          if [ $i -eq 0 ]; then
            JSON=$JSON\"${array_app_name[$i]}\"
          else
            JSON=$JSON,\"${array_app_name[$i]}\"
          fi

        done

        JSON=$JSON]
        echo "::set-output name=fncapp_json::$JSON"

  call_CI_part:
    uses: ./.github/workflows/continuous-integration.yaml
    needs: 
    - make_fncapp_json
    with:
      action_name: release_github
      matrix_json: ${{ needs.make_fncapp_json.outputs.matrix_json }}

  call_CD_github:
    uses: ./.github/workflows/continuous-deployment-github.yaml
    needs: 
    - make_fncapp_json
    - call_CI_part
    with:
      tag: ${{ github.ref }}
      matrix_json: ${{ needs.make_fncapp_json.outputs.matrix_json }}
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}  
      